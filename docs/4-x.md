# 4: Medium Access Control Sublayer

- 介质访问控制子层
- 位于数据链路层的地步
- 用于在广播通信介质中，确定谁有权使用该信道（信道控制）

## 4.1 信道分配协议

- 信道分配的方式：
    - 静态分配：比如物理层中介绍的频分复用，波分复用，码分复用等等。
        - 在处理突发流量时效率低下，会导致频谱浪费或延迟增加
        - 举例：假设帧平均以$\lambda$帧/秒的速率到达，帧的平均长度为$1/\mu$比特。则信道的服务速率为$\mu C$帧/秒，则发送一个帧到容量为$C$bps的信道上的平均延迟时间$T=\frac{1}{\mu C-\lambda}$。
        - 现在将单一信道划分为$N$个独立的子信道，每个子信道的容量为$C/N$bps，每个子信道上的平均输入速率现在为$\lambda/N$。则平均延迟时间$T_N=\frac{1}{\mu (C/N)-(\lambda/N)}=NT$。
    - 动态信道分配：又叫多点接入，特点是信道并非在用户通信的时候固定分配给用户。
        - 5个基本的假设：
            - Independent traffic：N个独立站点（如计算机），每个站点都可以独立产生帧。在帧成功传输之前，站点被阻塞，什么也不能做。
            - Single channel：所有站点共用一个信道。
            - Observable collision：Collision（冲突）的意思是，多个帧同时在同一个信道上传输会在时间上重叠，进而导致信号混乱。所有站点都能检测到冲突的发生。发生冲突的帧必须稍后重新传输。
            - Continuous time / Slotted time：发送的时间可以是连续的；或者，发送的时间要被划分为离散的间隔（称为 slot 时隙），一个时隙可能包含0、1或多个帧，帧传输必须从时隙的开始时刻开始。
            - Carrier Sense or No Carrier Sense：如果有载波监听，则站点可以在尝试使用信道之前判断信道是否正在使用；如果没有载波监听，站点在尝试使用信道之前无法感知信道的状态，它们会直接开始传输，稍后才能确定传输是否成功。
        - 多路传输协议：ALOHA，CSMA等等

### 4.1.1 竞争性的协议

- ALOHA协议
    - Pure ALOHA
        - Continuous Time & No Carrier Sense
        - 任何站点在需要传输数据时，无需任何检测就可以直接传输。如果一段时间内没有收到确认，就认为传输过程中产生了冲突，在等待随机时间后重新发送。
        - Throughput（吞吐量）：$S=Ge^{-2G}$ ，其中G表示每个帧发送所需的时间内生成的总帧数的平均值（包括新帧和重传帧）。不过，在这段时间内生成帧数的概率服从泊松分布。
        - 最大吞吐量：当G = 0.5时，S = 1/(2e)，约为0.184。
    - Slotted ALOHA：将时间分成离散的slot，各站点只能在slot的开始处开始发帧
        - Slotted Time & No Carrier Sense
        - 一个帧的发送时间应小于等于一个slot的长度
        - Throughput：$S=Ge^{-G}$ 
        - 最大吞吐量：当G = 1时，S = 1/e，约为0.368，是纯ALOHA的两倍

![image-20241212210055635](static/image-20241212210055635.png)

- CSMA协议(Carrier Sense Multiple Access Protocol)
    
    - Carrier Sense
    
    - 特点：在发送数据之前一直监听信道，如果冲突了就等待一段随机的时间之后再试一次
    
    - 在ALOHA基础上添加了一个载波监听装置。分为多种情况：
        - 1-persistant CSMA：
            - 要发送数据时，监听信道
                - 信道空闲则立即发送数据
                - 信道占用则持续监听，直到信道空闲，然后发送帧
            - 如果发生冲突，站点会等待一段随机时间，然后重新开始。
            - 带宽和延迟的乘积越大，信道上能容纳的帧数越大，冲突越容易发生，协议性能越差。
            - 以太网使用 1-persistant CSMA
        - non-persistant CSMA：
            - 要发送数据时，监听信道
                - 信道空闲则立即发送数据
                - 如果信道占用，它会等待一段随机时间，然后重复该算法。
            - 冲突少、信道的利用率高，但是延迟大
        - p-persistant CSMA：
            - 要发送数据时，监听信道
                - 信道空闲，则有一定的概率p立即发送数据，有1-p的概率推迟到下一个slot，重复判断信道是否空闲
                - 如果信道占用/发生冲突，它会等待一段随机时间，然后重复该算法。
            - IEEE 802.11使用优化后的p-persistant CSMA
        - Nonpersistent CSMA的等待时间过长，1-persistent CSMA很有可能会出现多个站点检测到信道空闲后同时发送的情况，p-persistent是二者的折中。
    

![image-20241212211933871](static/image-20241212211933871.png)

- CSMA/CD（CSMA with Collision Detection）
    - 在CSMA的基础上，在传输过程也检测冲突。如果冲突则停止数据发送，等待一段随机时间后重新传输。
        - 相比之下，未经改进的CSMA不会在传输过程中检测冲突，即使冲突了也继续发送
        - 如果站点读取的信号与它发出的信号不同，它就知道发生了冲突。
    
    - 假设信号在两个最远站点之间传播的时间为$\tau$ ，则在最坏情况下，一个站点在传输了$2\tau$时间且没有听到冲突之前，无法确定它已经占用了信道。
        - 常见错误结论：一个站点在开始传输后，如果在等于整个电缆传播时间的时间内没有听到冲突，就可以确定它已经占用了电缆。
        - 可以将CSMA/CD的竞争视为一个时隙宽度为$2\tau$的时隙ALOHA系统，不过帧传输时间时间通常远长于传播时间，因而CSMA/CD效率实际高很多。
    
    - 以太网采用这种策略。仅用于总线型/半双工网路环境（不能同时接收和发送），现代全双工网络环境两条信道一个发送一个传输，无需担心冲突。
    

![image-20241212214029133](static/image-20241212214029133.png)

### 4.2.2 非竞争和有限竞争（略）

Collision-Free Protocols（包括Token Passing、Binary Countdown）和Limited-Contention Protocols不考，课上也没讲，这里不展开。

### 4.2.3 Wireless LAN Protocols

- WLAN的特点

    - 无线通信系统通常不能检测出正在发生的冲突（站点接收到的信号可能非常微弱）
    - WLAN的站点可能无法给所有其他的站发送帧，也可能无法接受来自所有来自其他站的帧
    - 简化假设：每个无线电发射器都有一各固定的范围，用圆形来表示

- 一个简单的想法是使用CSMA：每个站点监听是否有其他的站点在传输，并且只有当没有其他站在传送数据的时候才进行传输，问题如下图所示：

    ![image-20201020230440351](static/image-20201020230440351.png)

    - 当A发送给B的时候，C在监听，但是监听不到A，因为在距离之外，因此错误地认为C可以向B发送数据，因此B处可能产生冲突。（上图a）
        - 由于竞争者离得太远而导致站点无法检测到潜在的竞争者，这个问题被称为hidden station problem（隐藏终端问题）
    - B向A传输，同时C想向D传输。如果C检测到了B正在传输，则它不会向D传输，但实际上是可以的。（上图b）
        - 这个问题被称为 exposed terminal problem（暴露终端问题）

- MACA（Multiple Access with Collision Avoidance）

    - 要求发送者广播发送一个RTS信号告知接收者，随后接收者广播一个CTS信号，这样两者附近所有设备都能知道它们之间正在传输，从而避免冲突。RTS（Request To Send）信号帧有30字节，包括源地址、目的地址和通信预期持续时间，CTS（Clear To Send）包括通信预期持续时间。
        - 如果一个站收到了RTS，则应保持一段时间的静默，避免与CTS冲突
        - 如果一个站收到了RTS但是没有收到CTS，则它可以正常传输它的数据，不会造成干扰
        - 如果一个站收到了CTS但是没有收到RTS，则它不能传输数据
        - 如果一个站同时收到了CTS和RTS，则它不能传输数据
    - MACA不能阻止冲突的发生，比如两个发送者同时广播RTS。
    
    ![image-20201020112537734](static/image-20201020112537734.png)

- MACAW（MACA for Wireless）
    - 在数据帧每次传输成功后，引入ACK信号；引入 retransmission 来防止丢帧。

## 4.3 以太网 IEEE 802.3 标准

- 以太网的分类：
    - Classical Ethernet（经典以太网）
    - Switched Ethernet（交换式以太网 ）：用Switch（交换机）来连接不同的计算机，目前主要使用的以太网类型
- 1978年为10 Mbps的以太网制定了DIX标准。经过微小的修改，DIX标准于1983年成为IEEE 802.3标准。
- 信息使用曼彻斯特编码进行传输。
- 以太网可以包含多个Cable Segments（电缆段）和多个Repeaters（中继器）

### 4.3.1 经典以太网的MAC子层协议

- 802.3的数据帧格式：

    - Preamble（前导码）是8个字节，前7个字节是10101010，最后一个字节是10101011（称为SOF 帧起始定界符 Start of Frame delimiter）
    - 目标地址和源地址都是6字节的长度
        - 目标地址的第一位是0/1分别表示 ordinary address 和 group address，使用后者传输称为multicast（组播），前者称为 unicast（单播）
        - 目标地址全是1则是 broadcast（广播）
        - 站点源地址为全球唯一，其实就是MAC地址
            - 前3个字节为OUI（组织唯一标识符），由IEEE分配给制造商
            - 制造商分配地址的最后3个字节，并将完整的地址编码到网卡（NIC）中
    - 接下来是 Type or Length field（类型或长度字段）
        - 类型代码0x0800表示数据包含IPv4数据包。
        - 由于这两种规范混用，有时候分不清这段存的是类型还是长度。因此规定，任何小于或等于0x600（1536）的数字都可以解释为长度，任何大于0x600的数字都可以解释为类型。

    - 数据字段最多可以有1500个字节。
    - 以太网要求从目的地址到checksum（有效帧）的长度至少是64字节，因此需要有0-46字节的填充区
        - 这是为了满足$2\tau$的round-trip delay（往返传播时间）。802.3规定，对于具有最大长度2500米和四个中继器的10 Mbps局域网，这个时间约为50微秒，在10 Mbps时，一个比特需要100纳秒，因此500比特是最小的帧，四舍五入到512bit。
    - Checksum（校验和）一般是4字节（32位）的CRC。

    ![image-20241212224127125](static/image-20241212224127125.png)

- `Binary Exponential Backoff`二进制指数退避算法： 

    - 经典以太网使用1-persistent CSMA/CD算法，但使用二进制指数退避算法确定重试时间间隔。
    - 将slot长度设置为512bit对应的round-trip delay，即51.2微秒
    - 在第i次的冲突之后，随机等待$0\rightarrow \min (2^i-1, 1023)$ 个slot
    - 在16次冲突后，控制器放弃并报告失败，返回更高层处理。
    - 如果只有少量的站冲突可以确保比较低的延迟，但是冲突的站点比较多的时候也可以保证一个合理的时间来解决冲突
    
- 以太网的信道效率（略，太复杂了，虽然也有考的可能）

    - 用帧长度 $F$、网络带宽 $B$、电缆长度$L$ 和信号传播速度$c$表示，对于每帧$e$个竞争slot的最佳情况下，信道效率$=\frac{1}{1+2BLe/cF}$


### 4.3.2 Switched Ethernet（交换式以太网）

- 传统以太网的第一步改进：用Hub（集线器）简单地将所有连接的电缆电连接在一起，在逻辑上等同于经典以太网的单一长电缆。
    - 在一个Hub下，连接的所有设备处于同一个collision domain下。

- Switch（交换机）：每个端口独立，帧只转发到目的端口，无冲突，性能更高。
    - 全双工时，多个站点和端口可同时发送帧；半双工时，需使用CSMA/CD。
        - 由于两个帧可能同时发送到同一个输出端口，交换机必须有缓冲区

    - 在交换机中，每个端口都是其自己的collision domain。
    - 例题：考虑8口Hub与8口Switch
        - Hub：当B$\rightarrow$C时，所有其他计算机不能同时发送。如果网络总带宽为10Mbps，平均每台节点机的最高带宽为：10/8=1.25 Mbps。
        - Switch：当B$\rightarrow$C时，同时可以进行：D$\rightarrow$A，E$\rightarrow$G，H$\rightarrow$F。网络总带宽为10$\times$4=40 Mbps，平均每台节点机的最高带宽为：10/2=5Mbps。当网卡及交换机都是全双工设备时，平均每台节点机的最高带宽为：5$\times$2=10Mbps。


### 4.3.3 Fast Ethernet 802.3u

- 要求位时间从 100 纳秒减少到 10 纳秒，从而提高速度
- 使用点对点链路，同时支持全双工与半双工
- 快速以太网基于双绞线布线，主要有三种实现方式：100Base-T4、100Base-TX 和 100Base-FX。
    - 100Base-T4 使用 3 类双绞线，需要四根线缆，信号速度为 25 MHz，采用三进制编码。
        - 本身是设计为半双工操作的，但是通过使用三对线进行发送和一对线进行接收，它能够同时发送和接收数据，实现了类似全双工的通信效果
        - 采用8B6T的编码方案，将8位的数据编码成6位的信号级别。这样，每对线实际上只能提供33.3Mbps的数据传输能力，但是由于有三对线同时发送，因此可以达到总共100Mbps的传输速度。
        - 使用三电平脉冲幅度调制（PAM-3）来编码数据。这意味着每个信号可以携带三个不同的值，这有助于提高数据密度而不需要增加频率，从而减少电磁干扰。
        - 时钟频率为25MHz。总共有27种信号模式，但只采用其中16种，因此1时钟周期发送4bit。
    - 100Base-TX 使用 5 类双绞线，信号速度为 125 MHz，采用 4B/5B 编码，支持100Mbps全双工。
    - 100Base-FX 使用多模光纤，支持100Mbps全双工，最大距离可达 2 公里。

### 4.3.4 Gigabit Ethernet 802.3z/802.3ab

- 同时支持全双工与半双工
    - 全双工（默认采用）：Buffered Central Switch, no contention, no CSMA/CD
    - 半双工：Hub, Collisions possible, CSMA/CD required
- 引入两个特征来增加半径：
    - Carrier extension（载波扩展）：告诉硬件在正常帧后添加自己的填充，将帧扩展到 512 字节。
    - Frame bursting（帧突发技术）：发送方在一次传输中发送多个帧的串联序列。如果总突发小于 512 字节，硬件会再次填充它。
- 8B/10B 编码，将 8 位数据编码为 10 位码字。使用 NRZ 发送编码。
- 布线类型
    - 1000Base-CX 短距离的屏蔽铜缆，两对STP。
    - 1000Base-SX 光纤。使用 0.85 微米的短波长，LED传输。多模光纤，最大传输距离 500 米
    - 1000Base-LX 光纤。使用 1.3 微米的长波长，激光传输。单模光纤（10 微米），最大传输距离 5 公里
    - 1000Base-T 5 类双绞线，通过复杂的信号处理技术实现了 1 Gbps 的传输速率。
        - 所有四对双绞线同时用于双向传输，通过数字信号处理分离信号。
        - 每根电线上使用 5 个电压电平，每个电平携带 2 位数据，信号传输速率为 125 Msymbols/sec。
        - 信号映射涉及 scrambling（用于过渡）和错误校正编码，将 4 个值嵌入到 5 个信号电平中。
- 引入flow control（流量控制），通过发送特殊的 PAUSE 控制帧（类型为 0x8808），接收方可以暂停数据接收，避免缓冲区溢出。
- 引入Jumbo Frames，减少帧率，降低与帧处理相关的开销

- 10 Gigabit Ethernet课上没有展开，此处略

## 4.4 Wireless LANs 802.11