# 6: Transport Layer

## 6.1 Transport Service

- 传输层服务也分为面向连接和无连接两种
    - 两种均有三个阶段：建立、数据传输和释放
    
- 在传输层中进行工作的软件和/或硬件称为 transport entity（传输实体）。

    - 用 segment（段）或者 TPDU（Transport Protocol Data Unit）表示传输实体间传输的消息。

        ![image-20241218200632919](static/image-20241218200632919.png)

- 传输层的代码完全运行在用户机器上，而网络层主要运行在路由器上。

- 使用传输层，OSI model 可以分为两部分：
    - Layers 1-4：transport service provider
    - Layers 5-7：transport service user

- 传输层隐藏网络服务的缺陷，即使用户进程位于不同的机器上，它们也可以假设存在一个无错误的比特流。

    - 传输层也可以提供 unreliable service（datagram），跟网络层的 datagram 道理差不多，这里不展开

- 网络服务只会被传输实体看到，但传输服务会被很多程序看到，因此需要一套简单的 primitives（原语）。

??? info "原语举例（感觉不如直接看下面的TCP原语）"
    考虑一个带有服务器和多个远程客户端的应用程序。
    - LISTEN：服务器调用库进程，阻塞服务器，直到有客户端出现
    - CONNECT：客户端想要与服务器通信时调用，用于建立连接。
        - 传输实体阻塞调用它的进程，向服务器发送 CONNECTION REQUEST 段。
        - 该段到达时，服务器的传输实体检查服务器是否在 LISTEN，如果在，它解除对服务端的阻塞，向客户端发送 CONNECTION ACCEPTED 段。
        - 当该段到达时，客户端被解除阻塞，连接建立。
    - SEND & RECEIVE：任何一方都可以执行一个（阻塞的）RECEIVE 来等待另一方执行 SEND。当段到达时，接收方被解除阻塞，然后它可以处理段并发送回复。
        - 传输层中每个发送的数据包都要被确认，传输实体也需要处理计时器和重传。
    - 断开连接有两种。
        - asymmetric variant：任何一方都可以发出一个 DISCONNECT 原语，发送一个 DISCONNECT 段到远程传输实体。到达后，连接被释放。
        - symmetric variant：当一方执行 DISCONNECT 后，不再发送更多数据，但仍然接受来自对方的数据。
    - 状态转换图如下。这里假设每个段都单独确认。我们还假设使用对称断开连接模型，客户端首先断开连接。
        ![image-20241218202047096](static/image-20241218202047096.png)

- TCP Socket 原语

    - 用于UNIX系统和Windows `winsock` API

        ![image-20241218202157031](static/image-20241218202157031.png)

    - 服务器端

        - SOCKET 原语创建一个新的 endpoint，并在传输实体中为其分配 table spaces。
            - 调用时指定要使用的 addressing format（寻址格式）、所需的服务类型（例如，可靠的字节流）以及协议。
            - 返回文件描述符（就像文件的OPEN调用一样）
        - BIND 原语分配网络地址。
            - 一旦服务器将地址绑定到套接字，远程客户端就可以连接到它。
        - LISTEN 原语为 incoming calls 分配 queue 空间，以防多个客户端同时尝试连接
            - Socket 模型的 LISTEN 不是一个阻塞调用
        - ACCEPT 原语阻塞并等待传入的连接
            - 当请求连接的段到达时，传输实体创建一个与原始套接字具有相同属性的新套接字，并返回其文件描述符。
            - 服务器可以fork出一个进程或线程来处理新套接字上的连接，并返回到原始套接字上等待下一个连接。

    - 客户端

        - 先使用 SOCKET 原语创建一个套接字，但不需要BIND
        - CONNECT 原语阻塞调用它的进程，并启动连接过程。
            - 连接进程从服务器接收到适当的段后，客户端进程被解除阻塞，连接建立
        - 使用 SEND 和 RECEIVE 在 full-duplex 连接上传输和接收数据
            - 也可以使用标准的UNIX READ和WRITE系统调用
        - symmetric connection release：当双方都执行了CLOSE原语时，连接被释放。

    - Socket API + TCP = 一个称为 reliable byte stream 的 connection-oriented service

    - 可以被用于其它 transport services，如 DCCP（Datagram Congestion Control Protocol）具有拥塞控制的UDP版本。

    - Socket API在每个流中进行拥塞控制，不如在整个group中进行

        - SCTP（Stream Control Transmission Protocol）和QUIC解决了这个问题。